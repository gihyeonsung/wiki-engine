---
title   : 아치리눅스 설치 과정 기록
date    : 2020-06-21 20:14:33 +0900
updated : 2020-06-22 22:55:13 +0900
category: 삽질록
tags    : 
---

아치리눅스 설치할 때마다, 삽질하는 것을 막기 위해 기록을 남긴다.

## 설치 준비

### 네트워크 연결확인

인터넷에서 시간을 받아오고 `pacstrap`을 사용하기 위해서 인터넷을 연결하고
확인한다.

```
ping hyeon.io
```

### 시스템 시계 설정하기

인터넷에서 시간을 받아오기 위해서 `timedatectl`을 사용했다.

```shell
timedatectl set-ntp true
```

(받아온 시간은 시스템 시간에 적용된다.)

### 스토리지 준비

큰 루트 파티션만 이용하고 싶었기 때문에, LVM을 사용했다.

파티션은 아래와 같이 준비했다.

```
Device    Start   End       Sectors   Size   Type  
/dev/sda1 2048    1050623   1048576   512M   EFI System
/dev/sda2 1050624 488397134 487346511 232.4G Linux LVM
/dev/sdb1 2048    488397134 488395087 232.9G Linux LVM
```

#### LVM 설정

```shell
# /dev/sda2, /dev/sdb1으로 PV 생성
pvcreate /dev/sda2
pvcreate /dev/sdb1

# /dev/sda2, /dev/sdb1를 사용해 VG 'lvm`을 생성
vgcreate lvm /dev/sda2 /dev/sdb1

# swap은 8GiB, /는 남는 vg의 전부로 파티션 생성
lvcreate -n swap -L 8g lvm
lvcreate -n root -l 100%FREE lvm
```

#### 포맷

```shell
mkfs.vfat -F32 /dev/sda1
# 아까 생성한 VG 'lvm'에 있는 LV 포맷
mkfs.ext4 /dev/lvm/root
mkswap /dev/lvm/swap

# 준비된 스왑은 바로 킨다.
swapon /dev/lvm/swap
```

### 마운트 & chroot

```shell
mount /dev/lvm/root /mnt
mkdir -p /mnt/boot
mount /dev/sda1 /mnt/boot
```

## 설치

### 미러 서버 설정

`/etc/pacman.d/mirrorlist`에 위에 있을수록 먼저 시도한다. 남한 미러 주소를
가장 위로 올린다.

생성된 미러가 설지 당시에는 망가졌을 수도 있다. 또한 사용할 프로토콜을 따로
지정하고 싶을 수도 있다. 그럴 때는 아치 리눅스 사이트에 있는
[미러 리스트](https://www.archlinux.org/mirrors/status/)에서 직접 보고 설정할
수도 있다.

### pacstrap

```shell
pacstrap /mnt base \
              linux \
              linux-firmware \
              lvm2 \
              neovim \
              networkmanager \
              systemd \
              intel-ucode
```

### fstab 생성하기

마운트된 상태를 `genfstab`이 감지해서 fstab 설정을 대신 만들어 준다.

```shell
genfstab -U /mnt >> /mnt/etc/fstab
```

### chroot

```shell
arch-chroot /mnt
```

### 지역화 하기

시간은 대한민국으로 언어는 영어로 설정했다.

```shell
# 타임존 서울로 설정하기
ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime

# 시스템 시계로 하드웨어 시계 설정하기
hwclock --systohc
```

`/etc/locale.gen`에서 `en_US.UTF-8 UTF-8`, `ko_KR.UTF-8 UTF-8` 주석 풀고,

```shell
# locale.gen 파일로 지역 만들기
locale-gen

# LANG 변수 설정하기
echo "LANG=en_US.UTF-8" > /etc/locale.conf
```

### 네트워크 설정

```shell
echo t440p > /etc/hostname
```

Systemd를 이용해 호스트를 찾지 않는 프로그램을 위해서 `/etc/hosts`를 설정한다.

```
127.0.0.1 localhost
::1       localhost
127.0.1.1 t440p.localdomain t440p
```

### initramfs 다시 생성하기

LVM을 `/`로 사용했기 때문에, `/etc/mkinitcpio.conf`를 다시 설정해야 했다.

`HOOKS` 배열에 `udev`를 추가하고 `lvm2`를 `block`과
`filesystems` 사이에 삽입한다.

```bash
HOOKS=(base udev autodetect modconf block lvm2 filesystems keyboard fsck)
```

LVM을 추가했으면 `mkinitcpio` 스크립트로 램디스크를 생성한다.

```shell
mkinitcpio -P
```

### 사용자 관리

#### root 계정

`passwd`로 로그아웃 하기 전에 비밀번호를 설정한다.

#### 개발용 계정

`root` 대신 사용할 계정을 만들었다.

```shell
useradd --no-user-group \
        --create-home \
        --gid wheel \
        gihyeon
```

추가: 아치리눅스는 초기 그룹에 `users`가 있는데, 왜 필요한지 몰라서 `--groups`
대신에 `--gid`로 `wheel`에만 들어가도록 설정했다.

계정을 만들고 나면 비밀번호를 설정해준다.

```shell
passwd gihyeon
```

### 부트로더 설치

`systemd-boot`를 사용했다.

```shell
bootctl install
```

그리고 부트로더를 설정해준다.

```
/boot/loader/loader.conf
default arch

/boot/loader/entries/arch.conf
title   Arch linux
linux   /vmlinuz-linux
initrd  /intel-ucode.img
initrd  /initramfs-linux.img
options root=/dev/mapper/lvm-root rw
```

### 종료

`chroot`를 나가고 `/mnt`에 마운트를 해제한다.

```shell
exit
umount -R /mnt
```
